// app.js  (gesti√≥n de navegaci√≥n / login / botones "volver")
// =============================

// Mostrar el formulario de registro
function mostrarRegistro() {
  const loginBox = document.getElementById("loginBox");
  const registerBox = document.getElementById("registerBox");
  if (loginBox) loginBox.style.display = "none";
  if (registerBox) registerBox.style.display = "block";
}

// Mostrar el formulario de login
function mostrarLogin() {
  const loginBox = document.getElementById("loginBox");
  const registerBox = document.getElementById("registerBox");
  if (registerBox) registerBox.style.display = "none";
  if (loginBox) loginBox.style.display = "block";
}

// -----------------------------
// Registro + Login seguro (CryptoJS) - reemplaza los handlers viejos
// -----------------------------
document.addEventListener("DOMContentLoaded", () => {

  const registerForm = document.getElementById("registerForm");
  const loginForm = document.getElementById("loginForm");

  // -------- REGISTRO (con clave maestra) --------
  if (registerForm) {
    registerForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const usuario = registerForm.querySelector("input[placeholder='Usuario nuevo']").value.trim();
      const email = registerForm.querySelector("input[placeholder='Email']").value.trim();
      const pass = registerForm.querySelector("input[placeholder='Contrase√±a']").value.trim();
      const pass2 = registerForm.querySelector("input[placeholder='Confirmar contrase√±a']").value.trim();
      const codigoVerificacionInput = registerForm.querySelector("#codigoVerificacion");
      const codigoVerificacion = codigoVerificacionInput ? codigoVerificacionInput.value.trim() : "";

      if (!usuario || !email || !pass || !pass2) {
        alert("Por favor, completa todos los campos.");
        return;
      }
      if (pass !== pass2) {
        alert("Las contrase√±as no coinciden.");
        return;
      }

      const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");

      // evitar emails repetidos
      if (usuarios.find(u => u.email === email)) {
        alert("Este email ya est√° registrado.");
        return;
      }

      // manejar master key
      const storedMasterHash = localStorage.getItem("masterKeyHash");
      if (storedMasterHash) {
        // si ya existe master => pedir codigo
        if (!codigoVerificacion) {
          alert("Debes ingresar el c√≥digo de verificaci√≥n para registrar una nueva cuenta.");
          return;
        }
        const codigoHash = CryptoJS.SHA256(codigoVerificacion).toString();
        if (codigoHash !== storedMasterHash) {
          alert("C√≥digo de verificaci√≥n incorrecto. No se puede registrar.");
          return;
        }
      } else {
        // primera vez: crear masterKey = codigoVerificacion (si puso) o pass
        const nuevaMaster = codigoVerificacion || pass;
        const nuevaMasterHash = CryptoJS.SHA256(nuevaMaster).toString();
        localStorage.setItem("masterKeyHash", nuevaMasterHash);
        // opcional: avisar al due√±o
        alert("üîê Clave maestra creada. Gu√°rdala: la necesitar√°s para permitir futuros registros.");
      }

      // cifrar contrase√±a con CryptoJS (misma "clave-secreta" en login)
      const passCifrada = CryptoJS.AES.encrypt(pass, "clave-secreta").toString();

      // guardar usuario
      usuarios.push({ usuario, email, pass: passCifrada });
      localStorage.setItem("usuarios", JSON.stringify(usuarios));

      // iniciar sesi√≥n autom√°ticamente y mostrar men√∫
      sessionStorage.setItem("usuarioActivo", usuario);

      // mostrar men√∫
      const contenedor1 = document.getElementById("contenedor1");
      const loginBox = document.getElementById("loginBox");
      const registerBox = document.getElementById("registerBox");
      const menuPrincipal = document.getElementById("menuPrincipal");
      if (loginBox) loginBox.style.display = "none";
      if (registerBox) registerBox.style.display = "none";
      if (contenedor1) contenedor1.style.display = "none";
      if (menuPrincipal) menuPrincipal.style.display = "block";

      alert("‚úÖ Usuario registrado e iniciado en sesi√≥n correctamente.");
    });
  }

  // -------- LOGIN (verifica con usuarios en localStorage) --------
  if (loginForm) {
    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();

      const usuario = document.getElementById("usuario").value.trim();
      const contrase√±a = document.getElementById("contrase√±a").value.trim();

      if (!usuario || !contrase√±a) {
        alert("Por favor, completa usuario y contrase√±a.");
        return;
      }

      const usuarios = JSON.parse(localStorage.getItem("usuarios") || "[]");

      // buscar usuario por nombre (o pod√©s cambiar a buscar por email)
      const user = usuarios.find(u => u.usuario === usuario);

      if (!user) {
        alert("Usuario no encontrado.");
        return;
      }

      // descifrar contrase√±a y comparar
      let passDescifrada = "";
      try {
        passDescifrada = CryptoJS.AES.decrypt(user.pass, "clave-secreta").toString(CryptoJS.enc.Utf8);
      } catch (err) {
        console.error("Error al descifrar:", err);
      }

      if (passDescifrada !== contrase√±a) {
        alert("Contrase√±a incorrecta.");
        return;
      }

      // todo correcto: iniciar sesi√≥n
      sessionStorage.setItem("usuarioActivo", usuario);

      // mostrar men√∫
      const contenedor1 = document.getElementById("contenedor1");
      const loginBox = document.getElementById("loginBox");
      const menuPrincipal = document.getElementById("menuPrincipal");
      if (loginBox) loginBox.style.display = "none";
      if (contenedor1) contenedor1.style.display = "none";
      if (menuPrincipal) menuPrincipal.style.display = "block";

      alert("Bienvenido, " + usuario);
      // cargar historial si existe la funci√≥n
      try {
        if (typeof window.mostrarHistorial === "function") window.mostrarHistorial();
      } catch (e) { console.warn(e); }
    });
  }

  // Sesi√≥n persistente en esta pesta√±a (si ya hab√≠a)
  const usuarioActivo = sessionStorage.getItem("usuarioActivo");
  if (usuarioActivo) {
    const contenedor1 = document.getElementById("contenedor1");
    const menuPrincipal = document.getElementById("menuPrincipal");
    if (contenedor1) contenedor1.style.display = "none";
    if (menuPrincipal) menuPrincipal.style.display = "block";
  }
  // Bot√≥n "Volver al men√∫" desde ANIMALES (usa id -> no pise otras funciones)
  const btnVolverAnimales = document.getElementById("volverMenuAnimales");
  if (btnVolverAnimales) {
    btnVolverAnimales.addEventListener("click", () => {
      // Ocultar secciones que puedan quedar abiertas
      const animales = document.getElementById("animales");
      const resultados = document.getElementById("resultados");
      const estadisticas = document.getElementById("estadisticas");
      const menu = document.getElementById("menuPrincipal");
      if (animales) animales.style.display = "none";
      if (resultados) resultados.style.display = "none";
      if (estadisticas) estadisticas.style.display = "none";
      if (menu) menu.style.display = "block";

      // Intentar recalcular totales si existe la funci√≥n
      try { if (typeof window.actualizarTotales === "function") window.actualizarTotales(); } catch (e) {}
    });
  }

  // Bot√≥n "Volver al men√∫" desde RESULTADOS (usa id distinto)
  const btnVolverResultados = document.getElementById("volverMenuResultados");
  if (btnVolverResultados) {
    btnVolverResultados.addEventListener("click", () => {
      const animales = document.getElementById("animales");
      const resultados = document.getElementById("resultados");
      const estadisticas = document.getElementById("estadisticas");
      const menu = document.getElementById("menuPrincipal");
      if (animales) animales.style.display = "none";
      if (resultados) resultados.style.display = "none";
      if (estadisticas) estadisticas.style.display = "none";
      if (menu) menu.style.display = "block";

      // opcional: si existe funci√≥n global para recargar algo
      try { if (typeof window.actualizarTotales === "function") window.actualizarTotales(); } catch (e) {}
    });
  }

  // Bot√≥n "Volver al men√∫" desde ESTAD√çSTICAS (usa id espec√≠fico)
  const btnVolverEstadisticas = document.getElementById("volverMenuEstadisticas");
  if (btnVolverEstadisticas) {
    btnVolverEstadisticas.addEventListener("click", () => {
      const animales = document.getElementById("animales");
      const resultados = document.getElementById("resultados");
      const estadisticas = document.getElementById("estadisticas");
      const menu = document.getElementById("menuPrincipal");
      if (animales) animales.style.display = "none";
      if (resultados) resultados.style.display = "none";
      if (estadisticas) estadisticas.style.display = "none";
      if (menu) menu.style.display = "block";

      // Si hay que actualizar totales, mantenerlo
      try { if (typeof window.actualizarTotales === "function") window.actualizarTotales(); } catch (e) {}
    });
  }

  // Bot√≥n "Volver al men√∫" desde REPORTES (usa id espec√≠fico)
  const btnVolverReportes = document.getElementById("volverMenuReportes");
  if (btnVolverReportes) {
    btnVolverReportes.addEventListener("click", () => {
      const reportes = document.getElementById("reportes");
      const menu = document.getElementById("menuPrincipal");
      if (reportes) reportes.style.display = "none";
      if (menu) menu.style.display = "block";
    });
  }

  // Cerrar sesi√≥n
  window.cerrarSesion = function() {
    const menuPrincipal = document.getElementById("menuPrincipal");
    const animales = document.getElementById("animales");
    const resultados = document.getElementById("resultados");
    const estadisticas = document.getElementById("estadisticas");
    const contenedor1 = document.getElementById("contenedor1");
    const loginBox = document.getElementById("loginBox");
    const registerBox = document.getElementById("registerBox");
    const reportes = document.getElementById("reportes");

    if (menuPrincipal) menuPrincipal.style.display = "none";
    if (animales) animales.style.display = "none";
    if (resultados) resultados.style.display = "none";
    if (estadisticas) estadisticas.style.display = "none";
    if (reportes) reportes.style.display = "none";
    if (contenedor1) contenedor1.style.display = "block";
    if (loginBox) loginBox.style.display = "block";
    if (registerBox) registerBox.style.display = "none";

    // limpiar campos por seguridad
    try {
      const usuario = document.getElementById("usuario");
      const contrase√±a = document.getElementById("contrase√±a");
      if (usuario) usuario.value = "";
      if (contrase√±a) contrase√±a.value = "";
    } catch (e) {}
  };

  // Al cargar la app, si existe mostrarHistorial, llamala para que el historial aparezca
  try {
    if (typeof window.mostrarHistorial === "function") {
      window.mostrarHistorial();
    }
  } catch (e) {
    // no interrumpimos si no existe
  }
});

// =============================
// SECCI√ìN REPORTES
// =============================
window.mostrarReportes = function() {
  const animales = document.getElementById("animales");
  const resultados = document.getElementById("resultados");
  const estadisticas = document.getElementById("estadisticas");
  const menu = document.getElementById("menuPrincipal");
  const reportes = document.getElementById("reportes");

  if (animales) animales.style.display = "none";
  if (resultados) resultados.style.display = "none";
  if (estadisticas) estadisticas.style.display = "none";
  if (menu) menu.style.display = "none";
  if (reportes) reportes.style.display = "block";
};


// =============================
// BOT√ìN DE CONTACTO (animado)
// =============================

// Esperamos a que cargue todo el DOM
document.addEventListener("DOMContentLoaded", () => {
  const btnContacto = document.getElementById("btnContacto");
  const panelContacto = document.getElementById("panelContacto");

  if (btnContacto && panelContacto) {
    // Mostrar/ocultar con animaci√≥n
    btnContacto.addEventListener("click", (e) => {
      e.stopPropagation();

      if (panelContacto.classList.contains("visible")) {
        // Si ya est√° visible, lo ocultamos
        panelContacto.classList.remove("visible");
        setTimeout(() => (panelContacto.style.display = "none"), 300);
      } else {
        // Si no, lo mostramos con animaci√≥n
        panelContacto.style.display = "block";
        setTimeout(() => panelContacto.classList.add("visible"), 10);
      }
    });

    // Si se hace clic fuera, se cierra autom√°ticamente
    document.addEventListener("click", (e) => {
      if (!btnContacto.contains(e.target) && !panelContacto.contains(e.target)) {
        if (panelContacto.classList.contains("visible")) {
          panelContacto.classList.remove("visible");
          setTimeout(() => (panelContacto.style.display = "none"), 300);
        }
      }
    });
  }
});






